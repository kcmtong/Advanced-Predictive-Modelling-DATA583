---
title: "Data 583 Life Expectancy (WHO)"
author: "Justin Chan, Kenny Tong, Viji Rajagopalan"
date: "7 Mar, 2023"
output: pdf_document
fontsize: 10pt
geometry: margin=2cm
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## EDA


### Original Dataset Summary & Initial Data Screening
Purpose : Let's take a snapshot of the original dataset and have a rough idea of its record
```{r}
le <- read.csv("dataset/LifeExpectancy.csv")
summary(le)
```
Let's look at the dataset dimension first
```{r}
dim(le)
```

Then, have a quick overall screening of the dataset
```{r}
#NOTE: might consider to remove this since str(le) provided us same information but in a more presentable 
#head(le,5)

```

Here is another view :
```{r}
str(le)
```

From the above broad view, the following Conclusion/Key Findings are reached : 

- The records range is from Year 2000 to 2015
- Columns with NA : Life Expectancy, Adult Mortality, Alcohol, Hep B, BMI, Polio, Total exp, Dip, GDP, Population, thinness..1.19, thinness.5.9, Income.composition.of.resources, Schooling
- 'Status' Column is of the "character" data type, with values "Developing" and "Developed".  We will introduce a new column 'Status.val' to be the factor value of 'Status' for better analysis..
- 'Percentage Expenditure' has a mean value of `r mean(le$percentage.expenditure)` and max. value of `r max(le$percentage.expenditure)`.  Spending on health is more than the GDP per capita? Look into the column definition : Expenditure on health as a percentage of Gross Domestic Product per capita(%). The data of such magnitude simply does not quite make sense. Cross check with other references (e.g. the World Bank https://data.worldbank.org/indicator/SH.XPD.CHEX.GD.ZS).  OK, let's conclude that we have hesitation about the reliability/interpretation of the value of this column, and probably would drop and skip this column for the rest of this analysis.
- 'Population' and 'GDP' have a relatively large scale, compared with all other columns.  So, we may need to scale these two columns.

Now, let's do some data wrangling based on the above conclusions :
```{r}
# Create a new column Status.val to represent the Status column with number
le$Status.val <- ifelse(le$Status == "Developed",1,0)

# Create a new column as the scaled version of the GDP & Population, 
le$GDP_scaled = scale(le$GDP)
le$Population_scaled = scale(le$Population)

# Remove the unreliable column 
le <- subset(le,select=-c(percentage.expenditure))

```

### Null Value Analysis and Handling
Purpose : Investigate the and determine how to handle the null value in the data set

Missing values could have a large affect to the overall quality of the static models and machine learning models and need to be clean before using it in our training model. 

Lets investigate how many missing values within our features:

```{r warning = FALSE, message=FALSE}
library(magrittr) 
library(dplyr)  
library(tidyr)

missing.values <- le %>%
    gather(key = "key", value = "val") %>%
    mutate(is.missing = is.na(val)) %>%
    group_by(key, is.missing) %>%
    summarise(num.missing = n()) %>%
    filter(is.missing==T) %>%
    select(-is.missing) %>%
    arrange(desc(num.missing)) 

missing.values
```

Next Step, we could visualize the missing data to identify patterns or cluster of missing values within our data to determine the cause of the missing data and whether it is random or systematic and to highlight potential biases that may exist in our data set. Visualizing the missing value also allow to understand the extend of the missing data and determine appropriate strategies for imputing missing value, since different imputation methods could be more appropriate depending on the pattern of the missing data.

```{r}
library(ggplot2)
library(gridExtra)

missing.values <- le %>%
  gather(key="key", value="val") %>%
  mutate(isna=is.na(val)) %>%
  group_by(key) %>%
  mutate(total=n()) %>%
  group_by(key,total,isna) %>%
  summarise(num.isna=n()) %>%
  mutate(pct=num.isna/total * 100)

levels <- (missing.values%>%filter(isna==T) %>% arrange(desc(pct)))$key

null_percentage.plot <- missing.values %>% ggplot() +
        geom_bar(aes(x = reorder(key, desc(pct)), 
                     y = pct, fill=isna), stat='identity', alpha=0.8) +
      scale_x_discrete(limits = levels) +
      scale_fill_manual(name = "", 
                        values = c('dodgerblue2', 'coral'), 
                        labels = c("Present", "Missing")) +
      coord_flip() + labs(title = "Percentage of missing values", 
                          x = 'Features', y = "% of missing values")

null_inrow.plot <- le %>%
  mutate(id = row_number()) %>%
  gather(-id, key = "key", value = "val") %>%
  mutate(isna = is.na(val)) %>%
  ggplot(aes(key, id, fill = isna)) +
    geom_raster(alpha=0.8) +
    scale_fill_manual(name = "",
        values = c('dodgerblue2', 'coral'),
        labels = c("Present", "Missing")) +
    scale_x_discrete(limits = levels) +
    labs(x = "Features", y = "Row Number", title = "Missing values in rows") +
    coord_flip()

options(repr.plot.width = 30, repr.plot.height = 20)
gridExtra::grid.arrange(null_percentage.plot, null_inrow.plot, ncol = 1) 


```

There are `r dim(le)[1]` no. of rows in the dataset. Acording to our Visualization, there seems to be a correlation in the appearance in missing data in feature "population", "gdp" , "income.composition.of.resources" and "schooling" indicated by the bottom plot.

```{r}

#le <- le[complete.cases(le$Population_scaled),] 
#le$Population,le$GDP,le$GDP_scaled,le$Income.composition.of.resources,le$Schooling),]

#le <- le[!is.na(le$Alcohol),]

library(dplyr)
le <- le %>% filter_at(vars(Population_scaled,Population,GDP,GDP_scaled,Income.composition.of.resources,Schooling),any_vars(!is.na(.)))

head(le)

missing.values <- le %>%
  gather(key="key", value="val") %>%
  mutate(isna=is.na(val)) %>%
  group_by(key) %>%
  mutate(total=n()) %>%
  group_by(key,total,isna) %>%
  summarise(num.isna=n()) %>%
  mutate(pct=num.isna/total * 100)

missing.values

levels <- (missing.values%>%filter(isna==T) %>% arrange(desc(pct)))$key

null_inrow.plot <- le %>%
  mutate(id = row_number()) %>%
  gather(-id, key = "key", value = "val") %>%
  mutate(isna = is.na(val)) %>%
  ggplot(aes(key, id, fill = isna)) +
    geom_raster(alpha=0.8) +
    scale_fill_manual(name = "",
        values = c('dodgerblue2', 'coral'),
        labels = c("Present", "Missing")) +
    scale_x_discrete(limits = levels) +
    labs(x = "Features", y = "Row Number", title = "Missing values in rows") +
    coord_flip()

null_inrow.plot
```


Let's set the threshold of 20% as the max. proportion of null column to be allowed in a data column.  That means, columns with na over 20% will be dropped.  The threshold is then  `r dim(le)[1] * 0.2`.  So, the following 'Population' column will be dropped.

```{r}
#head(le)
le <- subset(le,select=-c(Population))
# also Population_Scaled
le <- subset(le,select=-c(Population_scaled))

```


For the other values, we will set the na to the respective column mean for the subsequent analysis.

```{r message=FALSE, warning=FALSE}

for(i in 1:ncol(le)) {                                   # Replace NA in all columns
  le[ , i][is.na(le[ , i])] <- mean(le[ , i], na.rm = TRUE)
}

```

Now, all na have been handled!  Let's continue our analysis.




### Overall General Life Expectancy Trend

Purpose : Do some visualisation to explore and identify the general data pattern, trends and clusters, etc

```{r fig.height=3, fig.width=3, message=FALSE, warning=FALSE}
library(ggplot2)
#install.packages("tidyverse")
library(tidyverse)

le %>%
  group_by(Year) %>%
  summarise(Life.expectancy = mean(Life.expectancy)) %>%
  ggplot(aes(x=Year,
             y=Life.expectancy)) +    
  geom_line()

```

Findings :

- The general life expectancy has been steadily increasing duration the year
- Average Life expectancy increase from about 67 to 71.5 in 15 years.



```{r fig.height=3, fig.width=3, message=FALSE, warning=FALSE}
le %>%
  group_by(Status) %>%
  summarise(Life.expectancy = mean(Life.expectancy)) %>%
  ggplot(aes(x=Status,
             y=Life.expectancy,
             fill=Status)) +    
  geom_bar(stat = "identity")+ scale_fill_manual(values=c('dodgerblue2', 'coral'))

```
Finding :

- Life expectancy of Developed countries are significantly higher than that of Developing countries.

```{r fig.height=3, message=FALSE, warning=FALSE}
le.pivot <- pivot_longer(le,c(Adult.Mortality,under.five.deaths,infant.deaths),names_to='Mortality.Group',values_to='Mortality.Rate')
require(gridExtra)

le.pivot.area <- le.pivot %>%
  group_by(Year,Mortality.Group) %>%
  summarise(Mortality.Rate = mean(Mortality.Rate)) %>%
  ggplot(aes(x=Year,
             y=Mortality.Rate,
             fill=Mortality.Group)) +
  geom_area(position="stack",stat="identity")

le.pivot.line <- le.pivot %>%
  group_by(Year,Mortality.Group) %>%
  summarise(Mortality.Rate = mean(Mortality.Rate)) %>%
  ggplot(aes(x=Year,
             y=Mortality.Rate,
             color=Mortality.Group)) +
  geom_line()

grid.arrange(le.pivot.area, le.pivot.line, ncol=2)
```

Findings :

- The mortality rate of all three age groups are generally decreasing as a whole
- The mortality rate of the adult group, however, have fluctuation within the period




Variable Selections(Not yet finished):
```{r}
head(le)
```
```{r}
#convert Status and Country from type char to factor type, so that they can be used in statistical modeling where they will be implemented correctly
#le$Status <- factor(le$Status)
#le$Country <- factor(le$Country)
```

```{r}

#le[] <- lapply(le, function(x) if(is.numeric(x)){
#                     scale(x, center=TRUE, scale=TRUE)
#                      } else x)

le[,2]<-scale(le[,2])
le[,5:22]<-scale(le[,5:22])
head(le)
```




```{r}
#str(le)
class(le$Country)
glm_model <- glm(Life.expectancy~., data = le, family = "gaussian")
bic_back <- step(glm_model, k=log(nrow(le)), direction="backward", trace=FALSE)
summary(bic_back)
summary(glm_model)
```
bic_back <- step(glm_model, k=log(nrow(le)), direction="backward", trace=FALSE)
summary(bic_back)

```





